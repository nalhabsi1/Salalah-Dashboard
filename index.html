<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Salalah Project Progress Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <!-- MapLibre -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- Turf -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@7/turf.min.js"></script>

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- vis-timeline -->
  <link rel="stylesheet" href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css"/>
  <script src="https://unpkg.com/vis-data/peer/umd/vis-data.min.js"></script>
  <script src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>

  <style>
    :root{
       --bg:#f4f6fb; --panel:#ffffff; --panel2:#f7f9ff; --border:#e6ebff;
      --text:#0f1840; --muted:#5f6896;

      /* THEME (your choice) */
      --processed:#7b61ff;   /* purple = Digitized/Processed */
      --remaining:#ff5db1;   /* pink   = Pending/Remaining */
      --outline:#6672d5;

      /* Bars use same colors */
      --barDigitized: var(--processed);
      --barPending:   var(--remaining);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      background:linear-gradient(180deg,#f6f8ff 0%, #eef2ff 40%, #eef2ff 100%);
      font:18px/1.55 ui-sans-serif,system-ui,"Segoe UI",Roboto,Arial,sans-serif;
      overflow:hidden;
    }

    header{
      height:64px; display:flex; align-items:center; justify-content:space-between;
      padding:0 16px; border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.8));
      backdrop-filter: blur(6px);
      font-weight:900;
    }

    .app{
      height: calc(100vh - 64px);
      display:grid;
      grid-template-columns: 1.7fr 1fr;
      grid-template-rows: 1fr 420px;
      gap:12px; padding:12px;
    }

    .card{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow: 0 10px 24px rgba(20,28,84,.06);
      padding:12px; display:flex; flex-direction:column; min-width:0;
    }
    .card h4{ margin:2px 0 10px 0; font-weight:900; font-size:18px }

    /* left map + toggles + kpis */
    #mapAssets{ flex:1 1 auto; border-radius:12px; overflow:hidden }
    #assetToggles{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; font-size:16px }
    #assetToggles label{
      display:inline-flex; align-items:center; gap:8px;
      background:var(--panel2); color:var(--muted);
      border:1px solid var(--border); border-radius:999px; padding:6px 10px; cursor:pointer;
    }
    .legend-dot{ width:10px; height:10px; border-radius:50% }

    .kpis{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; margin-top:10px }
    .kpi{ background:var(--panel2); border:1px solid var(--border); padding:12px; border-radius:10px }
    .kpi .label{ color:var(--muted); font-size:14px }
    .kpi .value{ font-size:22px; font-weight:900 }

    /* right column */
    #mapProgress{ height: 42%; border-radius:12px; overflow:hidden }
    .charts{ display:grid; grid-template-columns: 0.8fr 1.2fr; gap:10px; height: calc(58% - 10px) }
    .chartbox{ background:var(--panel2); border:1px solid var(--border); border-radius:12px; padding:10px; position:relative; overflow:auto }
    .charts canvas{ width:100%; height:100% }

    .mini-legend{ position:absolute; top:8px; right:10px; display:flex; gap:12px; align-items:center; font-size:13px; color:var(--muted) }
    .mini-legend .dot{ width:12px; height:12px; border-radius:50% }

    /* timeline */
    #timeline{ height:100% }
    .vis-timeline{
      background:var(--panel2);
      border:1px solid var(--border); border-radius:14px; box-shadow: 0 8px 20px rgba(20,28,84,.08);
      font-size:16px;
    }
    .vis-timeline .vis-panel.vis-center,
    .vis-timeline .vis-panel.vis-left,
    .vis-timeline .vis-panel.vis-right{ border-color:#e4e9ff }
    .vis-time-axis .vis-text{ color:#050505; font-weight:800; font-size:14px }
    .vis-item.vis-range.task{
      color:#fff; border-radius:12px; height:28px; border-width:0;
      box-shadow:0 6px 18px rgba(33,37,79,.16);
      display:flex; align-items:center; padding:0 12px; font-weight:800;
    }
    .task.c1{ background:linear-gradient(90deg,#ff9ad5,#ff5db1) } /* pink family */
    .task.c2{ background:linear-gradient(90deg,#a78bff,#7b61ff) } /* purple family */
    .task.c3{ background:linear-gradient(90deg,#9ea8ff,#7d77ff) }
    .task.c4{ background:linear-gradient(90deg,#c59bff,#8f83ff) }

    .maplibregl-ctrl button{ width:38px;height:38px }
    .maplibregl-ctrl button .maplibregl-ctrl-icon{ background-size:26px 26px }
    .maplibregl-popup-content{
      background:#fff; color:#0f1840; border:1px solid var(--border); border-radius:12px;
      font-size:16px; line-height:1.55; padding:12px 14px;
      box-shadow:0 8px 18px rgba(0,0,0,.06);
    }

    .errbox{ position:fixed; inset:12px; z-index:999999; background:#fff; color:#1a2242;
      border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow:0 10px 20px rgba(0,0,0,.12); }
  </style>
</head>
<body>
<header>Salalah Project Progress Dashboard</header>

<div class="app">
  <!-- Left: big assets map and KPIs -->
  <section class="card" style="grid-column:1; grid-row:1 / span 2;">
    <h4>Assets Map</h4>
    <div id="assetToggles"></div>
    <div id="mapAssets"></div>

    <div class="kpis">
      <div class="kpi"><div class="label">Total Assets</div><div class="value" id="kpiAssets">0</div></div>
      <div class="kpi"><div class="label">Layers</div><div class="value" id="kpiLayers">0</div></div>
      <div class="kpi"><div class="label">% Processed</div><div class="value" id="kpiPct">0%</div></div>
      <div class="kpi"><div class="label">Remaining Items</div><div class="value" id="kpiRemain">0</div></div>
    </div>
  </section>

  <!-- Right: top progress map + donut + list -->
  <section class="card" style="grid-column:2; grid-row:1;">
    <h4>Area / Progress</h4>
    <div id="mapProgress"></div>
    <div class="charts">
      <div class="chartbox">
        <canvas id="areaChart"></canvas>
      </div>
      <div class="chartbox" id="barBox">
        <div class="mini-legend">
          <span class="dot" style="background:var(--barDigitized)"></span><span>Digitized</span>
          <span class="dot" style="background:var(--barPending)"></span><span>Pending</span>
        </div>
        <canvas id="assetBar"></canvas>
      </div>
    </div>
  </section>

  <!-- Timeline -->
  <section class="card" style="grid-column:2; grid-row:2;">
    <h4>Project Timeline</h4>
    <div id="timeline"></div>
  </section>
</div>

<!-- Error catcher -->
<script>
  window.addEventListener('error', e=>{
    const b=document.createElement('div'); b.className='errbox';
    b.innerHTML=`<b>JS Error</b><br>${e.message}<br><pre>${e.filename}:${e.lineno}:${e.colno}</pre>`;
    document.body.appendChild(b);
  }, true);
</script>

<script>
/* ======= CONFIG ======= */
const CENTER = [54.1, 17.02];
const baseStyle = 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json'; // light

/* Asset layer list (extend as needed) */
const ASSET_LAYERS = [
  { id:'ATMs', file:'data/ATMs.geojson', color:'#4cc9f0' },
  { id:'Banks', file:'data/Banks.geojson', color:'#a78bfa' },
  { id:'College', file:'data/College.geojson', color:'#f59e0b' },
  { id:'GasStations', file:'data/GasStations.geojson', color:'#22d3ee' },
  { id:'Insurance', file:'data/Insurance.geojson', color:'#e879f9' },
  { id:'LightPole', file:'data/LightPole.geojson', color:'#60a5fa' },
  { id:'Manholes', file:'data/Manholes.geojson', color:'#34d399' },
  { id:'MoneyExchange', file:'data/MoneyExchange.geojson', color:'#f472b6' },
  { id:'Nursery', file:'data/Nursery.geojson', color:'#f97316' },
  { id:'OTC', file:'data/OTC.geojson', color:'#c084fc' },
  { id:'Schools', file:'data/Schools.geojson', color:'#fb7185' },
  { id:'ServiceStations', file:'data/ServiceStations.geojson', color:'#22c55e' },
  { id:'TrainingCenter', file:'data/TrainingCenter.geojson', color:'#93c5fd' },
  { id:'University', file:'data/University.geojson', color:'#fbbf24' },

  /* (extra examples from your folder) */
  { id:'Bakery', file:'data/Bakery.geojson', color:'#f87171' },
  { id:'Butcher', file:'data/Butcher.geojson', color:'#fbbf24' },
  { id:'Cafes', file:'data/Cafes.geojson', color:'#34d399' },
  { id:'Churches', file:'data/churches.geojson', color:'#93c5fd' },
  { id:'CivilDefenseCenters', file:'data/CivilDefenseCenters.geojson', color:'#e879f9' },
  { id:'CleaningServices', file:'data/CleaningServices.geojson', color:'#60a5fa' },
  { id:'Clinics', file:'data/Clinics.geojson', color:'#fb923c' },
  { id:'ConstructionOffice', file:'data/ConstructionOffice.geojson', color:'#84cc16' },
  { id:'CosmeticsStore', file:'data/Cosmetics%20Store.geojson', color:'#f472b6' },
  { id:'EventsHalls', file:'data/Events%20Halls.geojson', color:'#22d3ee' },
  { id:'Florist', file:'data/florist.geojson', color:'#10b981' },
  { id:'GardenCenter', file:'data/GardenCenter.geojson', color:'#8b5cf6' },
  { id:'GovernmentOffice', file:'data/GovernmentOffice.geojson', color:'#ef4444' },
  { id:'Gym', file:'data/Gym.geojson', color:'#14b8a6' },
  { id:'Hotels', file:'data/Hotels.geojson', color:'#6366f1' },
  { id:'ManpowerRecruitmentOffice', file:'data/ManpowerRecruitmentOffice.geojson', color:'#a855f7' },
  { id:'Parks', file:'data/Parks.geojson', color:'#22c55e' },
  { id:'PhotographyStudio', file:'data/PhotographyStudio.geojson', color:'#f59e0b' },
  { id:'PoliceStation', file:'data/Police%20Station.geojson', color:'#0ea5e9' },
  { id:'PostOffice', file:'data/Post%20Office.geojson', color:'#ef476f' }
];

const PROCESSED_URL = 'data/Processed.geojson';
const REMAIN_URL    = 'data/remaining.geojson';

/* ======= HELPERS ======= */
async function loadJSON(u){ const r=await fetch(encodeURI(u)); if(!r.ok) throw new Error(u); return r.json(); }
async function loadText(u){ const r=await fetch(encodeURI(u)); if(!r.ok) throw new Error(u); return r.text(); }
function fitToFeatures(map, collection){ const bb = turf.bbox(collection); map.fitBounds([[bb[0],bb[1]],[bb[2],bb[3]]], { padding:30, duration:0 }); }
const valOrNA = v => (v==null || v==='' || v==='null' ? 'N/A' : v);
function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }

/* Normalize many CSV status spellings to the theme colors */
function statusToColor(raw){
  const s = String(raw||'').trim().toLowerCase().replace(/[\s_\-]/g,'');
  const purple = getCss('--processed');   // Digitized/Processed
  const pink   = getCss('--remaining');   // Pending/Remaining
  if (['digitized','processed','complete','completed','done'].includes(s)) return purple;
  if (['pending','remaining','todo','notstarted','inprogress','hold'].includes(s)) return pink;
  if (s.startsWith('digit')) return purple;   // handles typos like "digitzed"
  if (s.startsWith('pend') || s.startsWith('remain')) return pink;
  return purple; // default
}

/* ======= MAPS ======= */
const mapAssets = new maplibregl.Map({ container:'mapAssets', style:baseStyle, center:CENTER, zoom:12 });
mapAssets.addControl(new maplibregl.NavigationControl(), 'top-right');

const mapProgress = new maplibregl.Map({ container:'mapProgress', style:baseStyle, center:CENTER, zoom:12 });
mapProgress.addControl(new maplibregl.NavigationControl(), 'top-right');

/* ======= CHARTS ======= */
Chart.register(ChartDataLabels);
Chart.defaults.color = '#3a4070';
Chart.defaults.font.size = 18;
Chart.defaults.plugins.legend.labels.color = '#48508a';
Chart.defaults.plugins.legend.labels.font = { size: 16, weight:'bold' };

/* Donut — colors injected from the same CSS vars used by the progress map */
const areaChart = new Chart(document.getElementById('areaChart').getContext('2d'), {
  type:'doughnut',
  data:{
    labels:['Processed km²','Remaining km²'],
    datasets:[{
      data:[0,0],
      backgroundColor:['#aaa','#bbb'], /* replaced on map load */
      borderWidth:0
    }]
  },
  options:{
    cutout:'40%', /* small hole */
    plugins:{
      legend:{ position:'bottom' },
      datalabels:{ color:'#fff', font:{ weight:'900', size:16 }, formatter:v => (typeof v==='number'? v.toFixed(2)+' km²':v) }
    }
  }
});

/* Horizontal bar — TOP 20 by Count; color by normalized Status */
const assetBar = new Chart(document.getElementById('assetBar').getContext('2d'), {
  type:'bar',
  data:{ labels:[], datasets:[{ label:'Count', data:[], backgroundColor:[], borderRadius:10 }] },
  options:{
    indexAxis:'y',
    maintainAspectRatio:false,
    layout:{ padding:{ right:24, top:24 } },
    plugins:{
      legend:{ display:false },
      datalabels:{ anchor:'end', align:'right', formatter:v=>v, color:'#222', font:{ weight:'900', size:14 } }
    },
    scales:{
      x:{ beginAtZero:true, ticks:{ color:'#5a6090', font:{ size:14, weight:'bold' }}, grid:{ color:'rgba(90,96,144,.15)' } },
      y:{ ticks:{ color:'#3a3f6e', font:{ size:14, weight:'bold' }, autoSkip:false }, grid:{ display:false } }
    }
  }
});

/* ======= PROGRESS MAP + DONUT (match colors) ======= */
(async () => {
  const processed = await loadJSON(PROCESSED_URL).catch(()=>({features:[]}));
  const remaining = await loadJSON(REMAIN_URL).catch(()=>({features:[]}));

  mapProgress.on('load', () => {
    const COLOR_PROCESSED = getCss('--processed');
    const COLOR_REMAINING = getCss('--remaining');
    const COLOR_OUTLINE   = getCss('--outline');

    /* donut colors = progress map colors */
    areaChart.data.datasets[0].backgroundColor = [COLOR_PROCESSED, COLOR_REMAINING];
    areaChart.update();

    if (processed?.features?.length){
      mapProgress.addSource('processed', { type:'geojson', data:processed });
      mapProgress.addLayer({ id:'processed', type:'fill', source:'processed',
        paint:{ 'fill-color':COLOR_PROCESSED, 'fill-opacity':0.35, 'fill-outline-color':COLOR_OUTLINE }});
    }
    if (remaining?.features?.length){
      mapProgress.addSource('remaining', { type:'geojson', data:remaining });
      mapProgress.addLayer({ id:'remaining', type:'fill', source:'remaining',
        paint:{ 'fill-color':COLOR_REMAINING, 'fill-opacity':0.30, 'fill-outline-color':COLOR_OUTLINE }});
    }

    const all = { type:'FeatureCollection', features:[...(processed.features||[]), ...(remaining.features||[])] };
    if (all.features.length) fitToFeatures(mapProgress, all);

    // donut values (km² if polygons, else counts)
    let p=0, r=0;
    if (processed?.features) processed.features.forEach(f => { if (/Polygon/i.test(f.geometry?.type)) p+=turf.area(f)/1e6; });
    if (remaining?.features) remaining.features.forEach(f => { if (/Polygon/i.test(f.geometry?.type)) r+=turf.area(f)/1e6; });
    if ((p+r)===0){
      areaChart.data.labels=['Processed (count)','Remaining (count)'];
      p=processed?.features?.length||0; r=remaining?.features?.length||0;
      areaChart.options.plugins.datalabels.formatter = v => v;
    }
    areaChart.data.datasets[0].data=[+(p.toFixed(2)), +(r.toFixed(2))];
    areaChart.update();

    const pct = (p+r) ? Math.round((p/(p+r))*100) :
      Math.round(((processed?.features?.length||0)/(((processed?.features?.length||0)+(remaining?.features?.length||0))||1))*100);
    document.getElementById('kpiPct').textContent = `${isFinite(pct)?pct:0}%`;
    document.getElementById('kpiRemain').textContent = remaining?.features?.length||0;
  });
})();

/* ======= ASSETS MAP + POPUPS + BAR LIST (TOP 20) ======= */
mapAssets.on('load', async () => {
  const toggles = document.getElementById('assetToggles');
  const clickableLayerIds = [];
  let totalAssets = 0, layerCount = 0;
  const allFeatures = [];

  for (const layer of ASSET_LAYERS){
    let data; try{ data = await loadJSON(layer.file); } catch{ continue; }
    if (!data?.features?.length) continue;

    const src=`src_${layer.id}`, lyr=`lyr_${layer.id}`;
    mapAssets.addSource(src,{ type:'geojson', data });

    const geomType = (data.features.find(f=>f.geometry)?.geometry?.type)||'Point';
    if (/Point/i.test(geomType)){
      mapAssets.addLayer({
        id:lyr, type:'circle', source:src,
        paint:{
          'circle-radius':[ 'interpolate',['linear'],['zoom'], 8,5, 10,7, 12,9, 14,11, 16,13, 18,15 ],
          'circle-color': layer.color,
          'circle-stroke-color':'#ffffff',
          'circle-stroke-width':0.8
        }
      });
    } else if (/Line/i.test(geomType)){
      mapAssets.addLayer({ id:lyr, type:'line', source:src, paint:{ 'line-width':2.5, 'line-color':layer.color }});
    } else {
      mapAssets.addLayer({ id:lyr, type:'fill', source:src,
        paint:{ 'fill-color':layer.color, 'fill-opacity':0.35, 'fill-outline-color':'#ffffff' }});
    }
    clickableLayerIds.push(lyr);

    const chip = document.createElement('label');
    chip.innerHTML = `<span class="legend-dot" style="background:${layer.color}"></span>
      <input type="checkbox" checked data-lyr="${lyr}" style="transform:translateY(1px)"><span>${layer.id}</span>`;
    toggles.appendChild(chip);
    chip.querySelector('input').addEventListener('change', e=>{
      mapAssets.setLayoutProperty(lyr,'visibility', e.target.checked?'visible':'none');
    });

    totalAssets += data.features.length;
    layerCount++;
    allFeatures.push(...data.features);
  }

  if (allFeatures.length) fitToFeatures(mapAssets, { type:'FeatureCollection', features: allFeatures });
  document.getElementById('kpiAssets').textContent = totalAssets.toLocaleString();
  document.getElementById('kpiLayers').textContent = layerCount;

  mapAssets.on('mousemove',(e)=>{
    const feats = mapAssets.queryRenderedFeatures(e.point, { layers: clickableLayerIds });
    mapAssets.getCanvas().style.cursor = feats.length ? 'pointer' : '';
  });

  mapAssets.on('click',(e)=>{
    const feats = mapAssets.queryRenderedFeatures(e.point, { layers: clickableLayerIds });
    if (!feats.length) return;
    const f = feats[0]; const p=f.properties||{};
    const layerName = f.layer.id.replace(/^lyr_/,'');

    const id   = valOrNA(p['Asset_ID']);
    const name = valOrNA(p['Name']??p['name']);
    const dist = valOrNA(p['District_ID']);
    const wlyt = valOrNA(p['Wlyt_ID']);
    const gov  = 'Dhofar';

    const html = `<div style="min-width:280px">
        <div style="font-weight:900;margin-bottom:6px;font-size:18px;color:#4450c8">${layerName}</div>
        <div><b>ID:</b> ${id}</div>
        <div><b>Name:</b> ${name}</div>
        <div><b>District:</b> ${dist}</div>
        <div><b>Wilyat:</b> ${wlyt}</div>
        <div><b>Governorate:</b> ${gov}</div>
        <div style="margin-top:6px"><b>Lat/Lon:</b> ${e.lngLat.lat.toFixed(6)}, ${e.lngLat.lng.toFixed(6)}</div>
      </div>`;
    new maplibregl.Popup({ closeButton:true, maxWidth:'360px' })
      .setLngLat(e.lngLat).setHTML(html).addTo(mapAssets);
  });

  /* Build BAR LIST from data/count.csv (Asset, Status, Count) -> TOP 20; robust status coloring */
  try{
    const csv = await loadText('data/count.csv');
    const lines = csv.trim().split(/\r?\n/);
    const header = lines.shift().split(',').map(s=>s.trim().toLowerCase());
    const iAsset=header.indexOf('asset'), iStatus=header.indexOf('status'), iCount=header.indexOf('count');

    let items = lines.map(l=>{
      const c=l.split(',').map(x=>x.trim());
      const asset=(c[iAsset]||'').trim();
      const rawStatus=(c[iStatus]||'');
      const color = statusToColor(rawStatus);
      const value= +(c[iCount]||0);
      return {asset, value, color};
    }).filter(d=>d.asset && Number.isFinite(d.value));

    // sort by count desc and keep TOP 20
    items = items.sort((a,b)=>b.value-a.value).slice(0,20);

    assetBar.data.labels = items.map(d=>d.asset);
    assetBar.data.datasets[0].data = items.map(d=>d.value);
    assetBar.data.datasets[0].backgroundColor = items.map(d=>d.color);
    assetBar.update();
  }catch(e){ /* ignore if missing */ }
});

/* ======= TIMELINE (same layout; one task per row) ======= */
(function(){
  const groups = new vis.DataSet([
    { id:'g1', content:'' },
    { id:'g2', content:'' },
    { id:'g3', content:'' },
    { id:'g4', content:'' },
  ]);

  const items = [
    { id:1, group:'g1', content:'Establishments Digitizing', start:new Date('2025-07-20'), end:new Date('2025-08-28'), className:'task c1', type:'range' },
    { id:2, group:'g2', content:'Dashboard Editing',        start:new Date('2025-08-18'), end:new Date('2025-08-21'), className:'task c2', type:'range' },
    { id:3, group:'g3', content:'Streets Digitizing',       start:new Date('2025-08-31'), end:new Date('2025-09-25'), className:'task c3', type:'range' },
    { id:4, group:'g4', content:'Land Use Digitizing',      start:new Date('2025-08-31'), end:new Date('2025-09-25'), className:'task c4', type:'range' }
  ];

  const ds = new vis.DataSet(items);
  const tl = new vis.Timeline(document.getElementById('timeline'), ds, {
    groups,
    stack:true, orientation:'top', selectable:false, moveable:false, zoomKey:'ctrlKey',
    showCurrentTime:false, timeAxis:{ scale:'day', step:7 },
    margin:{ item:10, axis:10 },
    format:{ minorLabels:{ day:'D MMM' }, majorLabels:{ month:'MMMM YYYY' } }
  });

  tl.setWindow(new Date('2025-07-10'), new Date('2025-10-05'), { animation:false });
})();
</script>
</body>
</html>
